<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Winter AR Scene â€¢ A-Frame</title>
    <meta name="description" content="Winter AR Scene - Tap to place snowmen and trees">
    <!-- Load A-Frame library for creating WebXR/AR experiences -->
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <!-- script src="https://aframe.io/aframe/dist/aframe-master.min.js"></script -->
    <script>
      /**
       * SNOWMAN COMPONENT
       * This custom A-Frame component procedurally generates a snowman using basic 3D shapes.
       * When attached to an entity, it creates a complete snowman with body, face features, and hat.
       */
      AFRAME.registerComponent('snowman', {
        init() {
          // Get reference to the entity this component is attached to
          // Get reference to the entity this component is attached to
          const entity = this.el;
          
          // Create the snowman's body using three white spheres of decreasing size
          // Bottom sphere (largest) - base of the snowman
          const bottom = document.createElement('a-sphere');
          bottom.setAttribute('position', '0 0.6 0');
          bottom.setAttribute('radius', '0.6');
          bottom.setAttribute('color', '#FFFFFF');
          bottom.setAttribute('shadow', 'cast: true');  // Enable shadow casting for realism
          entity.appendChild(bottom);
          
          // Middle sphere (medium) - torso
          const middle = document.createElement('a-sphere');
          middle.setAttribute('position', '0 1.4 0');
          middle.setAttribute('radius', '0.45');
          middle.setAttribute('color', '#FFFFFF');
          middle.setAttribute('shadow', 'cast: true');
          entity.appendChild(middle);
          
          // Head sphere (smallest) - the head
          const head = document.createElement('a-sphere');
          head.setAttribute('position', '0 2 0');
          head.setAttribute('radius', '0.3');
          head.setAttribute('color', '#FFFFFF');
          head.setAttribute('shadow', 'cast: true');
          entity.appendChild(head);
          
          // Create facial features
          // Left eye - small black sphere positioned on the left side of the head
          const leftEye = document.createElement('a-sphere');
          leftEye.setAttribute('position', '-0.1 2.05 0.25');
          leftEye.setAttribute('radius', '0.05');
          leftEye.setAttribute('color', '#000000');
          entity.appendChild(leftEye);
          
          // Right eye - small black sphere positioned on the right side of the head
          const rightEye = document.createElement('a-sphere');
          rightEye.setAttribute('position', '0.1 2.05 0.25');
          rightEye.setAttribute('radius', '0.05');
          rightEye.setAttribute('color', '#000000');
          entity.appendChild(rightEye);
          
          // Carrot nose - orange cone rotated 90 degrees to point forward
          const nose = document.createElement('a-cone');
          nose.setAttribute('position', '0 1.95 0.35');
          nose.setAttribute('radius-bottom', '0.05');
          nose.setAttribute('radius-top', '0');
          nose.setAttribute('height', '0.2');
          nose.setAttribute('rotation', '90 0 0');  // Rotate to point outward
          nose.setAttribute('color', '#FF6347');  // Tomato red/orange color
          entity.appendChild(nose);
          
          // Coal buttons on the torso - two black spheres vertically aligned
          const button1 = document.createElement('a-sphere');
          button1.setAttribute('position', '0 1.5 0.42');
          button1.setAttribute('radius', '0.06');
          button1.setAttribute('color', '#000000');
          entity.appendChild(button1);
          
          const button2 = document.createElement('a-sphere');
          button2.setAttribute('position', '0 1.3 0.43');
          button2.setAttribute('radius', '0.06');
          button2.setAttribute('color', '#000000');
          entity.appendChild(button2);
          
          // Top hat - classic snowman accessory made of two black cylinders
          // Hat brim - wider, flat cylinder
          const hatBrim = document.createElement('a-cylinder');
          hatBrim.setAttribute('position', '0 2.4 0');
          hatBrim.setAttribute('radius', '0.35');
          hatBrim.setAttribute('height', '0.1');
          hatBrim.setAttribute('color', '#000000');
          entity.appendChild(hatBrim);
          
          // Hat top - narrower, tall cylinder
          const hatTop = document.createElement('a-cylinder');
          hatTop.setAttribute('position', '0 2.7 0');
          hatTop.setAttribute('radius', '0.2');
          hatTop.setAttribute('height', '0.5');
          hatTop.setAttribute('color', '#000000');
          entity.appendChild(hatTop);
        }
      });
      
      /**
       * PINE TREE COMPONENT
       * This custom A-Frame component procedurally generates a pine tree.
       * Creates a layered Christmas tree with trunk, three tiers of foliage, and a star on top.
       */
      AFRAME.registerComponent('pine-tree', {
        init() {
          // Get reference to the entity this component is attached to
          // Get reference to the entity this component is attached to
          const entity = this.el;
          
          // Create brown tree trunk using a cylinder
          const trunk = document.createElement('a-cylinder');
          trunk.setAttribute('position', '0 0.3 0');
          trunk.setAttribute('radius', '0.15');
          trunk.setAttribute('height', '0.6');
          trunk.setAttribute('color', '#8B4513');  // Saddle brown color
          trunk.setAttribute('shadow', 'cast: true');
          entity.appendChild(trunk);
          
          // Create tree foliage using three stacked cones of decreasing size
          // This creates the classic Christmas tree silhouette
          
          // Bottom tier - largest cone, darkest green
          const bottomTier = document.createElement('a-cone');
          bottomTier.setAttribute('position', '0 0.8 0');
          bottomTier.setAttribute('radius-bottom', '0.8');
          bottomTier.setAttribute('radius-top', '0');  // Pointy top
          bottomTier.setAttribute('height', '1');
          bottomTier.setAttribute('color', '#228B22');  // Forest green
          bottomTier.setAttribute('shadow', 'cast: true');
          entity.appendChild(bottomTier);
          
          // Middle tier - medium cone, medium green
          const middleTier = document.createElement('a-cone');
          middleTier.setAttribute('position', '0 1.4 0');
          middleTier.setAttribute('radius-bottom', '0.6');
          middleTier.setAttribute('radius-top', '0');
          middleTier.setAttribute('height', '0.8');
          middleTier.setAttribute('color', '#2E8B57');  // Sea green
          middleTier.setAttribute('shadow', 'cast: true');
          entity.appendChild(middleTier);
          
          // Top tier - smallest cone, lightest green
          const topTier = document.createElement('a-cone');
          topTier.setAttribute('position', '0 1.9 0');
          topTier.setAttribute('radius-bottom', '0.4');
          topTier.setAttribute('radius-top', '0');
          topTier.setAttribute('height', '0.6');
          topTier.setAttribute('color', '#32CD32');  // Lime green
          topTier.setAttribute('shadow', 'cast: true');
          entity.appendChild(topTier);
          
          // Gold star tree topper - uses octahedron (8-sided diamond shape)
          const star = document.createElement('a-octahedron');
          star.setAttribute('position', '0 2.3 0');
          star.setAttribute('radius', '0.1');
          star.setAttribute('color', '#FFD700');  // Gold color
          entity.appendChild(star);
        }
      });
      
      /**
       * SPAWN-ON-TAP COMPONENT
       * This component handles AR hit testing and spawns winter objects when the user taps.
       * Replaces the default ar-hit-test behavior to create new objects instead of moving them.
       * Alternates between spawning snowmen and pine trees with each tap.
       */
      AFRAME.registerComponent('spawn-on-tap', {
        init() {
          // Store references to scene elements
          this.scene = this.el.sceneEl;  // The main A-Frame scene
          this.container = document.querySelector('#spawn-container');  // Container for spawned objects
          this.objectCount = 0;  // Track how many objects have been spawned
          this.currentType = 'snowman';  // Track which type to spawn next (alternates)
          
          // Bind the hit test handler method to maintain correct 'this' context
          this.onHitTest = this.onHitTest.bind(this);
          this.onHitTestStart = this.onHitTestStart.bind(this);
          this.restoreHitTest = this.restoreHitTest.bind(this);
          
          // Listen for AR hit test select start event (fired when user starts tapping)
          this.scene.addEventListener('ar-hit-test-select-start', this.onHitTestStart);
          
          // Listen for AR hit test select event (fired when user completes tap)
          this.scene.addEventListener('ar-hit-test-select', this.onHitTest);
        },
        
        /**
         * Called when user starts tapping on a detected AR surface
         * Store the hit test reference before it gets cleared
         */
        onHitTestStart(event) {
          var arHitTestComponent = this.scene.components['ar-hit-test'];
          if (arHitTestComponent) {
            // Store reference to the viewer hit test so we can restore it
            this.viewerHitTest = arHitTestComponent.viewerHitTest;
          }
        },
        
        /**
         * Called when user taps on a detected AR surface
         * @param {Event} event - Contains position data from the AR hit test
         */
        onHitTest(event) {
          // Extract the 3D position where the user tapped
          const position = event.detail.position;
          
          // Create a new entity at the tapped location
          const newEntity = document.createElement('a-entity');
          newEntity.setAttribute('position', `${position.x} ${position.y} ${position.z}`);
          newEntity.setAttribute('scale', '0.15 0.15 0.15');  // Scale down to appropriate AR size
          newEntity.setAttribute('shadow', 'cast: true; receive: false');  // Enable shadows
          
          // Alternate between spawning snowman and pine tree
          if (this.currentType === 'snowman') {
            newEntity.setAttribute('snowman', '');  // Attach snowman component
            this.currentType = 'tree';  // Next tap will spawn a tree
          } else {
            newEntity.setAttribute('pine-tree', '');  // Attach pine-tree component
            this.currentType = 'snowman';  // Next tap will spawn a snowman
          }
          
          // Add the new object to the scene's spawn container
          this.container.appendChild(newEntity);
          this.objectCount++;
          
          // Log spawn info to console for debugging
          console.log(`Spawned ${this.currentType === 'tree' ? 'snowman' : 'pine tree'} #${this.objectCount} at`, position);
          
          // Restore the hit test after a brief delay to allow for continuous spawning
          setTimeout(this.restoreHitTest, 100);
        },
        
        /**
         * Restores the hit test capability after spawning an object
         * This allows the user to spawn multiple objects
         */
        restoreHitTest() {
          var arHitTestComponent = this.scene.components['ar-hit-test'];
          if (arHitTestComponent && this.viewerHitTest) {
            // Restore the viewer hit test that was cleared by ar-hit-test component
            arHitTestComponent.hitTest = this.viewerHitTest;
          }
        },
        
        /**
         * Cleanup when component is removed - prevents memory leaks
         */
        remove() {
          this.scene.removeEventListener('ar-hit-test-select-start', this.onHitTestStart);
          this.scene.removeEventListener('ar-hit-test-select', this.onHitTest);
        }
      });
    </script>
  </head>
  <body>
    <!-- 
      A-FRAME SCENE CONFIGURATION
      Main AR scene with custom spawn behavior and optimized rendering
    -->
    <a-scene
      spawn-on-tap
      ar-hit-test="enabled: true;"
      webxr="optionalFeatures: hit-test, anchors;"
      renderer="colorManagement: true; exposure: 1; toneMapping: ACESFilmic"
      shadow="type: pcfsoft"
      xr-mode-ui="XRMode: xr"
    >
      <!-- Directional light for realistic shadows and lighting -->
      <a-light type="directional" light="castShadow:true;" position="1 1 1" intensity="1.57"></a-light>
      
      <!-- AR Camera positioned at typical user height with keyboard controls for testing -->
      <a-camera position="0 0.4 0" wasd-controls="acceleration:10;"></a-camera>
      
      <!-- Container for all spawned winter objects (snowmen and trees) -->
      <a-entity id="spawn-container"></a-entity>
      
      <!-- Sky background (light blue) - hidden when entering AR mode -->
      <a-sky color="#87CEEB" hide-on-enter-ar></a-sky>
    </a-scene>
  </body>
</html>
